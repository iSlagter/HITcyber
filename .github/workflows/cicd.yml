name: Trigger auto deployment for HIT cyber course

on:
  push:
    branches: 
      [ master ]
    paths:
    - '**'
    - '.github/workflows/hit-c-app-AutoDeployTrigger.yml'

  workflow_dispatch:      

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions: 
      id-token: write
      contents: read

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v2

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.HITCAPP_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.HITCAPP_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.HITCAPP_AZURE_SUBSCRIPTION_ID }}

      - name: Build and push container image (Secure)
        run: |
          docker build -t hitacr.azurecr.io/hit-cyber-image-secure:latest ./communication_ltd_secure
          echo "${{ secrets.HITCAPP_REGISTRY_PASSWORD }}" | docker login hitacr.azurecr.io -u "${{ secrets.HITCAPP_REGISTRY_USERNAME }}" --password-stdin
          docker push hitacr.azurecr.io/hit-cyber-image-secure:latest

      - name: Build and push container image (Vulnerable)
        run: |
          docker build -t hitacr.azurecr.io/hit-cyber-image-vulnerable:latest ./communication_ltd_vulnerable
          echo "${{ secrets.HITCAPP_REGISTRY_PASSWORD }}" | docker login hitacr.azurecr.io -u "${{ secrets.HITCAPP_REGISTRY_USERNAME }}" --password-stdin
          docker push hitacr.azurecr.io/hit-cyber-image-vulnerable:latest

      - name: Deploy Web App from ACR (Secure)
        run: |
          az webapp config container set --name hit-app-secure --resource-group HIT --docker-custom-image-name hitacr.azurecr.io/hit-cyber-image-secure:latest --docker-registry-server-url https://hitacr.azurecr.io --docker-registry-server-user ${{ secrets.HITCAPP_REGISTRY_USERNAME }} --docker-registry-server-password ${{ secrets.HITCAPP_REGISTRY_PASSWORD }}

      - name: Deploy Web App from ACR (Vulnerable)
        run: |
          az webapp config container set --name hit-app-vulnerable --resource-group HIT --docker-custom-image-name hitacr.azurecr.io/hit-cyber-image-vulnerable:latest --docker-registry-server-url https://hitacr.azurecr.io --docker-registry-server-user ${{ secrets.HITCAPP_REGISTRY_USERNAME }} --docker-registry-server-password ${{ secrets.HITCAPP_REGISTRY_PASSWORD }}
